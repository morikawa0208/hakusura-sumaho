<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>縦持ちハクスラ試作</title>
  <style>
    :root {
      --bg: #070912;
      --panel: rgba(18, 24, 38, 0.55);
      --glass-highlight: rgba(255, 255, 255, 0.28);
      --glass-shadow: rgba(0, 0, 0, 0.28);
      --accent: #34d399;
      --accent-2: #60a5fa;
      --accent-3: #a78bfa;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --blur: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: radial-gradient(circle at 16% 18%, rgba(52, 211, 153, 0.16), transparent 30%),
        radial-gradient(circle at 84% 22%, rgba(96, 165, 250, 0.15), transparent 30%),
        radial-gradient(circle at 50% 90%, rgba(167, 139, 250, 0.12), transparent 32%),
        linear-gradient(135deg, #080b16 0%, #0c1020 40%, #080b16 100%);
      color: var(--text);
      font-family: "Segoe UI", "Hiragino Sans", system-ui, -apple-system, sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 12px;
      backdrop-filter: blur(8px);
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: absolute;
      inset: 12px;
      border-radius: 24px;
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.06), transparent 50%),
        radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.05), transparent 50%);
      filter: blur(30px);
      pointer-events: none;
      opacity: 0.55;
    }

    .phone {
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.22);
      border-radius: 22px;
      width: min(460px, 100%);
      height: calc(100vh - 12px);
      display: grid;
      grid-template-rows: auto auto 1fr auto auto auto;
      gap: 8px;
      padding: 12px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.12);
      overflow: hidden;
      backdrop-filter: blur(var(--blur));
      border-top: 1px solid rgba(255, 255, 255, 0.38);
      border-left: 1px solid rgba(255, 255, 255, 0.24);
      border-right: 1px solid rgba(255, 255, 255, 0.12);
      position: relative;
    }

    .phone::before {
      content: "";
      position: absolute;
      inset: -20%;
      background: radial-gradient(circle at 20% 15%, rgba(52, 211, 153, 0.18), transparent 35%),
        radial-gradient(circle at 80% 20%, rgba(96, 165, 250, 0.14), transparent 32%),
        radial-gradient(circle at 60% 75%, rgba(167, 139, 250, 0.14), transparent 35%);
      filter: blur(60px);
      opacity: 0.55;
      pointer-events: none;
    }

    .card {
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.35);
      border-radius: 12px;
      padding: 10px;
      backdrop-filter: blur(var(--blur));
    }

    .subtle {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .bars {
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    .bar {
      position: relative;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      border-radius: 999px;
      height: 22px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 1px 5px rgba(255, 255, 255, 0.1), 0 10px 22px rgba(0, 0, 0, 0.26);
      backdrop-filter: blur(calc(var(--blur) * 0.75));
    }

    .bar span {
      position: absolute;
      inset: 0;
      width: 50%;
      border-radius: 999px;
      filter: saturate(1.2);
      box-shadow: inset 0 -4px 12px rgba(0, 0, 0, 0.18), 0 0 12px rgba(255, 255, 255, 0.1);
    }

    .bar .label {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: 12px;
      color: #f8fafc;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .bar .hp {
      background: #ef4444;
    }

    .bar .mp {
      background: #3b82f6;
    }

    .bar .exp {
      background: #facc15;
    }

    #log {
      background: linear-gradient(160deg, rgba(17, 24, 39, 0.5), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      line-height: 1.5;
      overflow: auto;
      height: 170px;
      max-height: 280px;
      min-height: 130px;
      resize: vertical;
      display: flex;
      flex-direction: column;
      gap: 6px;
      backdrop-filter: blur(calc(var(--blur) * 0.8));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 16px 32px rgba(0, 0, 0, 0.24);
    }

    .log-card {
      display: flex;
      flex-direction: column;
    }

    .log-card #log {
      flex: 1;
    }

    #log .entry {
      opacity: 0.97;
      padding: 4px 6px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.14);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.28);
    }

    #log .entry.info {
      color: #e5e7eb;
    }

    #log .entry.player {
      color: #93c5fd;
    }

    #log .entry.enemy {
      color: #fca5a5;
    }

    #log .entry.good {
      color: #6ee7b7;
    }

    #log .entry.warning {
      color: #fcd34d;
    }

    #log .entry.danger {
      color: #fb7185;
    }

    #actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    button {
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.32), rgba(96, 165, 250, 0.32));
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease, border-color 0.1s ease;
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.32), inset 0 1px 0 rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(var(--blur));
    }

    button:hover {
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 16px 28px rgba(0, 0, 0, 0.36);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .menu {
      display: flex;
      justify-content: space-around;
      gap: 6px;
    }

    .pill {
      font-size: 12px;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.08));
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      backdrop-filter: blur(calc(var(--blur) * 0.55));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12), 0 10px 18px rgba(0, 0, 0, 0.18);
    }

    .tag {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.06));
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      letter-spacing: 0.03em;
      border: 1px solid rgba(255, 255, 255, 0.28);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(calc(var(--blur) * 0.55));
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      font-size: 13px;
    }

    .inline-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      padding: 8px;
      border-radius: 10px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 12px 22px rgba(0, 0, 0, 0.26);
      backdrop-filter: blur(calc(var(--blur) * 0.55));
    }

    .stat-label {
      display: grid;
      gap: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .stat-value {
      font-weight: 700;
      font-size: 13px;
      text-align: right;
    }

    .stat-value .total {
      font-weight: 800;
    }

    .stat-value .base {
      color: var(--muted);
      font-weight: 600;
    }

    .stat-value .bonus {
      color: var(--accent);
      font-weight: 800;
    }

    .stat-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    details {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.04));
      border-radius: 12px;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(calc(var(--blur) * 0.55));
    }

    .enemy-list {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      font-size: 13px;
      padding-bottom: 2px;
    }

    .enemy-card {
      display: grid;
      gap: 6px;
      padding: 9px;
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.08s ease, border-color 0.12s ease, box-shadow 0.12s ease;
      min-width: 0;
      box-shadow: 0 14px 24px rgba(0, 0, 0, 0.28);
      backdrop-filter: blur(calc(var(--blur) * 0.62));
    }

    .enemy-card:active {
      transform: translateY(1px);
    }

    .enemy-card:hover {
      border-color: rgba(255, 255, 255, 0.42);
      box-shadow: 0 18px 30px rgba(0, 0, 0, 0.32);
    }

    .enemy-top {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: space-between;
    }

    .enemy-name {
      display: grid;
      gap: 2px;
      font-weight: 600;
    }

    .enemy-bar {
      position: relative;
      background: linear-gradient(125deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.04));
      border-radius: 999px;
      height: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .enemy-bar .fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #ef4444, #fb7185);
      width: 50%;
      border-radius: 999px;
    }

    .enemy-bar .label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      line-height: 1;
      color: #f8fafc;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      width: min(420px, 94%);
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 20px 46px rgba(0, 0, 0, 0.52), inset 0 1px 0 rgba(255, 255, 255, 0.12);
      max-height: 90vh;
      overflow-y: auto;
      backdrop-filter: blur(var(--blur));
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 0.03em;
    }

    .help-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.24);
      backdrop-filter: blur(calc(var(--blur) * 0.4));
    }

    .help-panel {
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 12px;
      line-height: 1.5;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(calc(var(--blur) * 0.45));
    }

    .modal-body-title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .help-panel ul {
      padding-left: 16px;
      margin: 6px 0;
    }

    .modal-close {
      border: none;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
      color: var(--text);
      border-radius: 999px;
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    details summary {
      cursor: pointer;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

  </style>
</head>
<body>
  <div class="phone">
    <section class="card">
      <div id="enemies" class="enemy-list"></div>
    </section>

    <section class="card">
      <div class="subtle" style="justify-content: flex-start; gap: 10px; margin-bottom: 4px;">
        <span>LV <span id="level"></span></span>
        <span class="pill">階層 <span id="floor-inline"></span>F</span>
      </div>
      <div class="bars">
        <div class="bar">
          <span id="hp-bar" class="hp"></span>
          <span id="hp-label" class="label"></span>
        </div>
        <div class="bar">
          <span id="mp-bar" class="mp"></span>
          <span id="mp-label" class="label"></span>
        </div>
        <div class="bar">
          <span id="exp-bar" class="exp"></span>
          <span id="exp-label" class="label"></span>
        </div>
      </div>
    </section>

    <section class="card log-card">
      <div id="log"></div>
    </section>

    <section class="card">
      <div class="subtle" style="margin-bottom: 8px;">
        <div class="menu">
          <span class="pill">HP: <span id="hp-inline"></span></span>
          <span class="pill">MP: <span id="mp-inline"></span></span>
          <span class="pill">EXP: <span id="exp-inline"></span></span>
        </div>
      </div>
      <div id="actions"></div>
    </section>

    <section class="card">
      <div class="subtle">
        <span>ステータス</span>
        <span class="tag" id="stat-points"></span>
      </div>
      <div class="stats">
        <div>
          <div class="inline-buttons">
            <button id="str-up" style="flex:1;">STR+</button>
            <button id="int-up" style="flex:1;">INT+</button>
          </div>
          <div class="inline-buttons">
            <button id="vit-up" style="flex:1;">VIT+</button>
            <button id="agi-up" style="flex:1;">AGI+</button>
          </div>
          <div class="inline-buttons">
            <button id="luck-up" style="flex:1;">LUC+</button>
          </div>
        </div>
        <div class="stat-grid" id="primary-stats"></div>
      </div>
      <details style="margin-top: 8px;">
        <summary>詳細ステータス</summary>
        <div class="stat-grid" id="secondary-stats"></div>
        <div class="inline-buttons">
          <button id="reset-stats">リセット</button>
        </div>
      </details>
    </section>

    <section class="card">
      <div class="subtle" style="margin-bottom: 6px;">
        <span>スキル</span>
        <span class="tag" id="skill-points"></span>
      </div>
      <div class="stat-grid" id="skills"></div>
    </section>
  </div>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <div class="section-title">ヘルプ</div>
        <button class="modal-close" id="close-modal">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-body-title">遊び方</div>
        <div class="help-panel">
          <ul>
            <li>左上の敵カードをタップして攻撃を開始します。</li>
            <li>スキルとステータスを強化して階層を進みましょう。</li>
            <li>HPとMPは時間で回復します。</li>
          </ul>
        </div>
      </div>
      <div class="modal-actions">
        <button id="close-modal-button">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    const player = {
      base: {
        hp: 30,
        mp: 10,
        physAtk: 5,
        magAtk: 5,
        physDef: 3,
        magDef: 3,
        speed: 3,
        critRate: 5,
        critDamage: 150,
        evade: 3,
        physPen: 0,
        magPen: 0,
        damageReduction: 0,
        block: 0,
        statusResist: 0,
        debuffResist: 0,
        curseResist: 0,
        cooldown: 0,
        hpRegen: 1,
        lifeSteal: 0,
        barrier: 0,
        dropRate: 0,
        rarity: 0,
      },
      primary: {
        str: { base: 3, bonus: 0 },
        int: { base: 3, bonus: 0 },
        vit: { base: 3, bonus: 0 },
        agi: { base: 3, bonus: 0 },
        luck: { base: 3, bonus: 0 },
      },
      secondary: {
        hp: { base: 0, bonus: 0, total: 0 },
        mp: { base: 0, bonus: 0, total: 0 },
        physAtk: { base: 0, bonus: 0, total: 0 },
        magAtk: { base: 0, bonus: 0, total: 0 },
        physDef: { base: 0, bonus: 0, total: 0 },
        magDef: { base: 0, bonus: 0, total: 0 },
        speed: { base: 0, bonus: 0, total: 0 },
        critRate: { base: 0, bonus: 0, total: 0 },
        critDamage: { base: 0, bonus: 0, total: 0 },
        evade: { base: 0, bonus: 0, total: 0 },
        physPen: { base: 0, bonus: 0, total: 0 },
        magPen: { base: 0, bonus: 0, total: 0 },
        damageReduction: { base: 0, bonus: 0, total: 0 },
        block: { base: 0, bonus: 0, total: 0 },
        statusResist: { base: 0, bonus: 0, total: 0 },
        debuffResist: { base: 0, bonus: 0, total: 0 },
        curseResist: { base: 0, bonus: 0, total: 0 },
        cooldown: { base: 0, bonus: 0, total: 0 },
        hpRegen: { base: 0, bonus: 0, total: 0 },
        lifeSteal: { base: 0, bonus: 0, total: 0 },
        barrier: { base: 0, bonus: 0, total: 0 },
        dropRate: { base: 0, bonus: 0, total: 0 },
        rarity: { base: 0, bonus: 0, total: 0 },
      },
      bonus: {
        hp: 0,
        mp: 0,
        physAtk: 0,
        magAtk: 0,
        physDef: 0,
        magDef: 0,
        speed: 0,
        critRate: 0,
        critDamage: 0,
        evade: 0,
        physPen: 0,
        magPen: 0,
        damageReduction: 0,
        block: 0,
        statusResist: 0,
        debuffResist: 0,
        curseResist: 0,
        cooldown: 0,
        hpRegen: 0,
        lifeSteal: 0,
        barrier: 0,
        dropRate: 0,
        rarity: 0,
      },
      statPoints: 3,
      skillPoints: 0,
      buffs: { guard: 0, haste: 0, focus: 0 },
    };

    const game = {
      floor: 1,
      enemies: [],
      turnQueue: [],
      awaitingInput: false,
      defeatedBosses: 0,
    };

    const skills = {
      sharpEdge: {
        name: "鋭刃",
        desc: "物理攻撃+2 (最大3)",
        level: 0,
        max: 3,
        apply: () => (player.bonus.physAtk += 2),
      },
      quickStep: {
        name: "疾駆",
        desc: "速度+2 (最大2)",
        level: 0,
        max: 2,
        apply: () => (player.bonus.speed += 2),
      },
      arcaneFlow: {
        name: "魔力循環",
        desc: "最大MP+2 (最大2)",
        level: 0,
        max: 2,
        apply: () => (player.bonus.mp += 2),
      },
    };

    function log(message, type = "info") {
      const logBox = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = `entry ${type}`;
      entry.textContent = message;
      logBox.appendChild(entry);
      logBox.scrollTop = logBox.scrollHeight;
    }

    const primaryOrder = ["str", "int", "vit", "agi", "luck"];
    let cachedSecondaries = null;
    let pendingResetSpent = 0;

    const displayNumber = (num, { forceDecimal = false } = {}) => {
      if (forceDecimal) {
        return (Math.round(num * 10) / 10).toFixed(1);
      }
      return Number.isInteger(num) ? Math.round(num) : Number((Math.round(num * 10) / 10).toFixed(1));
    };

    const formatStatValue = (stat, unit = "") => {
      if (!stat) return "-";
      const isPercent = unit === "%";
      const total = `${displayNumber(stat.total, { forceDecimal: isPercent })}${unit}`;
      if (!stat.bonus) {
        return `<span class="total">${total}</span>`;
      }
      const bonusSign = stat.bonus > 0 ? "+" : "";
      const base = displayNumber(stat.base, { forceDecimal: isPercent });
      const bonus = displayNumber(stat.bonus, { forceDecimal: isPercent });
      return `<span class="total">${total}</span> (<span class="base">${base}</span> <span class="bonus">${bonusSign}${bonus}</span>)`;
    };

    const formatPrimaryValue = (stat) => {
      const total = stat.base + stat.bonus;
      const bonusSign = stat.bonus > 0 ? "+" : "";
      const baseText = stat.bonus ? ` (<span class="base">${stat.base}</span> <span class="bonus">${bonusSign}${stat.bonus}</span>)` : "";
      return `<span class="total">${total}</span>${baseText}`;
    };

    const statTotal = (key) => {
      const stat = player.primary[key];
      return stat.base + stat.bonus;
    };

    function calcSecondaryStats() {
      const str = statTotal("str");
      const int = statTotal("int");
      const vit = statTotal("vit");
      const agi = statTotal("agi");
      const luck = statTotal("luck");

      const maxHpBase = player.base.hp + vit * 10;
      const maxMpBase = player.base.mp + int * 2 + vit * 0.5;
      const physAtkBase = player.base.physAtk + str * 1.2;
      const magAtkBase = player.base.magAtk + int * 1.2;
      const physDefBase = player.base.physDef + vit * 0.8;
      const magDefBase = player.base.magDef + int * 0.8;
      const speedBase = player.base.speed + agi * 0.9;
      const critRateBase = player.base.critRate + luck * 0.6;
      const critDamageBase = player.base.critDamage + luck * 1.5;
      const evadeBase = player.base.evade + agi * 0.5;
      const physPenBase = player.base.physPen + str * 0.3;
      const magPenBase = player.base.magPen + int * 0.3;
      const damageReductionBase = player.base.damageReduction + vit * 0.2;
      const blockBase = player.base.block + vit * 0.4;
      const statusResistBase = player.base.statusResist + luck * 0.25 + vit * 0.15;
      const debuffResistBase = player.base.debuffResist + luck * 0.25;
      const curseResistBase = player.base.curseResist + luck * 0.25;
      const cooldownBase = player.base.cooldown - agi * 0.3;
      const hpRegenBase = player.base.hpRegen + vit * 0.3;
      const lifeStealBase = player.base.lifeSteal + str * 0.2;
      const barrierBase = player.base.barrier + int * 0.4 + vit * 0.6;
      const dropRateBase = player.base.dropRate + luck * 0.8;
      const rarityBase = player.base.rarity + luck * 0.3;

      const bonus = player.bonus;

      player.secondary.hp = {
        base: maxHpBase,
        bonus: bonus.hp,
        total: maxHpBase + bonus.hp,
      };
      player.secondary.mp = {
        base: maxMpBase,
        bonus: bonus.mp,
        total: maxMpBase + bonus.mp,
      };
      player.secondary.physAtk = {
        base: physAtkBase,
        bonus: bonus.physAtk,
        total: physAtkBase + bonus.physAtk,
      };
      player.secondary.magAtk = {
        base: magAtkBase,
        bonus: bonus.magAtk,
        total: magAtkBase + bonus.magAtk,
      };
      player.secondary.physDef = {
        base: physDefBase,
        bonus: bonus.physDef,
        total: physDefBase + bonus.physDef,
      };
      player.secondary.magDef = {
        base: magDefBase,
        bonus: bonus.magDef,
        total: magDefBase + bonus.magDef,
      };
      player.secondary.speed = {
        base: speedBase,
        bonus: bonus.speed,
        total: speedBase + bonus.speed,
      };
      player.secondary.critRate = {
        base: critRateBase,
        bonus: bonus.critRate,
        total: critRateBase + bonus.critRate,
      };
      player.secondary.critDamage = {
        base: critDamageBase,
        bonus: bonus.critDamage,
        total: critDamageBase + bonus.critDamage,
      };
      player.secondary.evade = {
        base: evadeBase,
        bonus: bonus.evade,
        total: evadeBase + bonus.evade,
      };
      player.secondary.physPen = {
        base: physPenBase,
        bonus: bonus.physPen,
        total: physPenBase + bonus.physPen,
      };
      player.secondary.magPen = {
        base: magPenBase,
        bonus: bonus.magPen,
        total: magPenBase + bonus.magPen,
      };
      player.secondary.damageReduction = {
        base: damageReductionBase,
        bonus: bonus.damageReduction,
        total: damageReductionBase + bonus.damageReduction,
      };
      player.secondary.block = {
        base: blockBase,
        bonus: bonus.block,
        total: blockBase + bonus.block,
      };
      player.secondary.statusResist = {
        base: statusResistBase,
        bonus: bonus.statusResist,
        total: statusResistBase + bonus.statusResist,
      };
      player.secondary.debuffResist = {
        base: debuffResistBase,
        bonus: bonus.debuffResist,
        total: debuffResistBase + bonus.debuffResist,
      };
      player.secondary.curseResist = {
        base: curseResistBase,
        bonus: bonus.curseResist,
        total: curseResistBase + bonus.curseResist,
      };
      player.secondary.cooldown = {
        base: cooldownBase,
        bonus: bonus.cooldown,
        total: cooldownBase + bonus.cooldown,
      };
      player.secondary.hpRegen = {
        base: hpRegenBase,
        bonus: bonus.hpRegen,
        total: hpRegenBase + bonus.hpRegen,
      };
      player.secondary.lifeSteal = {
        base: lifeStealBase,
        bonus: bonus.lifeSteal,
        total: lifeStealBase + bonus.lifeSteal,
      };
      player.secondary.barrier = {
        base: barrierBase,
        bonus: bonus.barrier,
        total: barrierBase + bonus.barrier,
      };
      player.secondary.dropRate = {
        base: dropRateBase,
        bonus: bonus.dropRate,
        total: dropRateBase + bonus.dropRate,
      };
      player.secondary.rarity = {
        base: rarityBase,
        bonus: bonus.rarity,
        total: rarityBase + bonus.rarity,
      };

      player.secondary.hp.total = Math.max(1, player.secondary.hp.total);
      player.secondary.mp.total = Math.max(0, player.secondary.mp.total);
      player.secondary.critRate.total = Math.min(100, player.secondary.critRate.total);
    }

    function renderPrimaryStats() {
      const container = document.getElementById("primary-stats");
      container.innerHTML = "";

      primaryOrder.forEach((key) => {
        const stat = player.primary[key];
        const row = document.createElement("div");
        row.className = "stat-row";

        const label = document.createElement("div");
        label.className = "stat-label";
        label.innerHTML = `<strong>${key.toUpperCase()}</strong>`;

        const value = document.createElement("div");
        value.className = "stat-value";
        value.innerHTML = formatPrimaryValue(stat);

        row.appendChild(label);
        row.appendChild(value);
        container.appendChild(row);
      });
    }

    function renderSecondaryStats() {
      if (cachedSecondaries) {
        document.getElementById("secondary-stats").innerHTML = cachedSecondaries;
        return;
      }

      calcSecondaryStats();
      const stats = player.secondary;

      const rows = [
        ["HP", stats.hp, ""],
        ["MP", stats.mp, ""],
        ["物理攻撃", stats.physAtk, ""],
        ["魔法攻撃", stats.magAtk, ""],
        ["物理防御", stats.physDef, ""],
        ["魔法防御", stats.magDef, ""],
        ["速度", stats.speed, ""],
        ["クリ率", stats.critRate, "%"],
        ["クリダメ", stats.critDamage, "%"],
        ["回避", stats.evade, "%"],
        ["物理貫通", stats.physPen, "%"],
        ["魔法貫通", stats.magPen, "%"],
        ["被ダメ減少", stats.damageReduction, "%"],
        ["ブロック", stats.block, "%"],
        ["状態異常耐性", stats.statusResist, "%"],
        ["弱体耐性", stats.debuffResist, "%"],
        ["呪い耐性", stats.curseResist, "%"],
        ["CD短縮", { ...stats.cooldown, bonus: -stats.cooldown.bonus }, "%"],
        ["HP再生", stats.hpRegen, ""],
        ["ライフスティール", stats.lifeSteal, "%"],
        ["バリア", stats.barrier, ""],
        ["ドロップ率", stats.dropRate, "%"],
        ["レア度UP", stats.rarity, "%"],
      ];

      const grid = document.getElementById("secondary-stats");
      grid.innerHTML = "";

      rows.forEach(([label, stat, unit]) => {
        const row = document.createElement("div");
        row.className = "stat-row";

        const labelEl = document.createElement("div");
        labelEl.className = "stat-label";
        labelEl.innerHTML = `<strong>${label}</strong>`;

        const value = document.createElement("div");
        value.className = "stat-value";
        value.innerHTML = formatStatValue(stat, unit);

        row.appendChild(labelEl);
        row.appendChild(value);
        grid.appendChild(row);
      });

      cachedSecondaries = grid.innerHTML;
    }

    const enemiesData = [
      { name: "スライム", maxHp: 15, hp: 15, exp: 4, loot: "ゼリー" },
      { name: "コウモリ", maxHp: 18, hp: 18, exp: 5, loot: "牙" },
      { name: "スケルトン", maxHp: 22, hp: 22, exp: 6, loot: "骨片" },
    ];

    function renderEnemies() {
      const container = document.getElementById("enemies");
      container.innerHTML = "";

      enemiesData.forEach((enemy, index) => {
        const card = document.createElement("div");
        card.className = "enemy-card";
        card.onclick = () => attackEnemy(index);

        const top = document.createElement("div");
        top.className = "enemy-top";
        top.innerHTML = `<div class="enemy-name">${enemy.name}<span class="tag">EXP ${enemy.exp}</span></div><span class="pill">${enemy.loot}</span>`;

        const bar = document.createElement("div");
        bar.className = "enemy-bar";
        const fill = document.createElement("div");
        fill.className = "fill";
        fill.style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = `${enemy.hp}/${enemy.maxHp}`;

        bar.appendChild(fill);
        bar.appendChild(label);

        card.appendChild(top);
        card.appendChild(bar);
        container.appendChild(card);
      });
    }

    function renderSkillButtons() {
      const container = document.getElementById("skills");
      container.innerHTML = "";

      Object.entries(skills).forEach(([key, skill]) => {
        const row = document.createElement("div");
        row.className = "stat-row";

        const label = document.createElement("div");
        label.className = "stat-label";
        label.innerHTML = `<strong>${skill.name}</strong><span class="muted">${skill.desc}</span>`;

        const actions = document.createElement("div");
        actions.className = "stat-actions";

        const level = document.createElement("span");
        level.className = "tag";
        level.textContent = `Lv ${skill.level}/${skill.max}`;

        const button = document.createElement("button");
        button.textContent = "強化";
        button.disabled = skill.level >= skill.max || player.skillPoints <= 0;
        button.onclick = () => levelUpSkill(key);

        actions.appendChild(level);
        actions.appendChild(button);

        row.appendChild(label);
        row.appendChild(actions);
        container.appendChild(row);
      });
    }

    function updateBars() {
      const hpFill = document.getElementById("hp-bar");
      const hpLabel = document.getElementById("hp-label");
      const mpFill = document.getElementById("mp-bar");
      const mpLabel = document.getElementById("mp-label");
      const expFill = document.getElementById("exp-bar");
      const expLabel = document.getElementById("exp-label");

      hpFill.style.width = `${Math.max(0, Math.min(100, (player.base.hp / player.secondary.hp.total) * 100))}%`;
      hpLabel.textContent = `${Math.round(player.base.hp)}/${Math.round(player.secondary.hp.total)}`;

      mpFill.style.width = `${Math.max(0, Math.min(100, (player.base.mp / player.secondary.mp.total) * 100))}%`;
      mpLabel.textContent = `${Math.round(player.base.mp)}/${Math.round(player.secondary.mp.total)}`;

      const expPercent = ((game.floor - 1) % 10) * 10;
      expFill.style.width = `${expPercent}%`;
      expLabel.textContent = `EXP ${expPercent}%`;

      document.getElementById("hp-inline").textContent = `${Math.round(player.base.hp)}/${Math.round(player.secondary.hp.total)}`;
      document.getElementById("mp-inline").textContent = `${Math.round(player.base.mp)}/${Math.round(player.secondary.mp.total)}`;
      document.getElementById("exp-inline").textContent = `${expPercent}%`;
    }

    function updatePoints() {
      document.getElementById("stat-points").textContent = `残りSP ${player.statPoints}`;
      document.getElementById("skill-points").textContent = `残りKP ${player.skillPoints}`;

      ["str", "int", "vit", "agi", "luck"].forEach((key) => {
        const btn = document.getElementById(`${key}-up`);
        btn.disabled = player.statPoints <= 0;
      });

      renderSkillButtons();
    }

    function attackEnemy(index) {
      if (game.awaitingInput) return;
      const enemy = enemiesData[index];
      if (enemy.hp <= 0) return;

      const dmg = Math.max(1, Math.round(player.secondary.physAtk.total + Math.random() * 3));
      enemy.hp = Math.max(0, enemy.hp - dmg);

      log(`あなたの攻撃！${enemy.name}に${dmg}ダメージ`, "player");

      if (enemy.hp <= 0) {
        log(`${enemy.name}を倒した！ ${enemy.exp}EXP獲得`, "good");
        game.floor += 1;
        player.skillPoints += 1;
        player.statPoints += 1;
      }

      renderEnemies();
      updateBars();

      const hit = Math.max(1, Math.round(Math.random() * 4));
      player.base.hp = Math.max(0, player.base.hp - hit);
      log(`${enemy.name}の反撃！${hit}ダメージ`, "enemy");

      if (player.base.hp <= 0) {
        log("倒れてしまった…ステータスがリセットされます", "danger");
        resetStats(true);
      } else {
        updateBars();
      }
    }

    function levelUpStat(key) {
      if (player.statPoints <= 0) return;
      player.primary[key].base += 1;
      player.statPoints -= 1;
      cachedSecondaries = null;
      pendingResetSpent += 1;
      refreshUI();
    }

    function levelUpSkill(key) {
      const skill = skills[key];
      if (player.skillPoints <= 0 || skill.level >= skill.max) return;
      skill.level += 1;
      player.skillPoints -= 1;
      skill.apply();
      cachedSecondaries = null;
      refreshUI();
      log(`${skill.name}をLv${skill.level}に強化！`, "good");
    }

    function resetStats(force = false) {
      if (!force && !window.confirm("ステータスをリセットしますか？")) return;

      Object.values(player.primary).forEach((stat) => {
        player.statPoints += stat.base - 3;
        stat.base = 3;
        stat.bonus = 0;
      });

      Object.values(skills).forEach((skill) => {
        player.skillPoints += skill.level;
        skill.level = 0;
      });

      Object.keys(player.bonus).forEach((key) => (player.bonus[key] = 0));
      player.base.hp = 30;
      player.base.mp = 10;
      cachedSecondaries = null;
      pendingResetSpent = 0;
      refreshUI();
      log("ステータスをリセットしました", "warning");
    }

    function refreshUI() {
      calcSecondaryStats();
      renderPrimaryStats();
      renderSecondaryStats();
      renderEnemies();
      renderSkillButtons();
      updateBars();
      updatePoints();
      document.getElementById("level").textContent = game.floor;
      document.getElementById("floor-inline").textContent = game.floor;
    }

    document.getElementById("str-up").onclick = () => levelUpStat("str");
    document.getElementById("int-up").onclick = () => levelUpStat("int");
    document.getElementById("vit-up").onclick = () => levelUpStat("vit");
    document.getElementById("agi-up").onclick = () => levelUpStat("agi");
    document.getElementById("luck-up").onclick = () => levelUpStat("luck");
    document.getElementById("reset-stats").onclick = () => resetStats();
    document.getElementById("close-modal").onclick = () => document.getElementById("modal").classList.add("hidden");
    document.getElementById("close-modal-button").onclick = () => document.getElementById("modal").classList.add("hidden");

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.getElementById("modal").classList.toggle("hidden");
      }
    });

    function autoRegen() {
      if (player.base.hp < player.secondary.hp.total) {
        player.base.hp = Math.min(player.secondary.hp.total, player.base.hp + player.secondary.hpRegen.total * 0.2);
      }
      if (player.base.mp < player.secondary.mp.total) {
        player.base.mp = Math.min(player.secondary.mp.total, player.base.mp + player.secondary.mp.total * 0.04);
      }
      updateBars();
    }

    setInterval(autoRegen, 1000);

    refreshUI();
  </script>
</body>
</html>
